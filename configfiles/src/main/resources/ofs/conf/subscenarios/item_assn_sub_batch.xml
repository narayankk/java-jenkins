<?xml version="1.0" encoding="UTF-8"?>

<scenario>
    <property key="name">item_assn - subscenario</property>
    <property key="description">Associate or disassociate set of tags to the specified locations based on scenario and process type.</property>
    <property key="sub_scenario">true</property>
    <property key="parent_access">R</property>
    <property key="namespace">assn-sub</property>
    <property key="exits">DONE,ERROR,NON_RECOVERABLE_ERROR</property>
    <property key="inputs">
       parentLocationEpc,readPointEpc,scenarioType,processType,processSubType,tags,user,
       processStartTime,processEndTime,elapsedTimeInSeconds,waypointFlag,toLocDesc,transferReason
       <!-- ,moveMissingItems,missingItemBL,missingItemRP -->
       <!-- ,receiveItemsAgain -->
    </property>
    <property key="outputs">failedEpcs</property>
    
    <process>

    <start name="Start">
      <target exit="Exit Condition" name="ResetProcessId"></target>
    </start>
        
    <activity name="ResetProcessId" resource="class:com.oatsystems.workflow.primitives.SetVariableValue">
      <target name="ResetFailedEpcsList" exit="done"/>
      <target name="ResetFailedEpcsList" exit="error"/>
      <input  name="value" class="java.lang.String">''</input>
      <output name="variable" class="java.lang.String">${process.processID}</output>
    </activity>

    
    
    <activity name="ResetFailedEpcsList" resource="primitive:SetVariablesToNull" >
      <target name="DecideOnInferringLocation" exit="done" />
      <target name="DecideOnInferringLocation" exit="skip" />
      <target name="DecideOnInferringLocation" exit="error" />
      <output name="variable0" class="java.util.Set">${process.failedEpcs}</output>
      <output name="variable1" class="java.lang.Object">${process.invalidAssociatedEpcList}</output>
    </activity>

     

        <!-- Fix for MV-2311 - parentLocationEpc will be null for Retirement, so GetSiteIdForLocation would error out-->
        <!-- GetInferredReceivingLocation returns the siteEpc so GetSiteIdForLocation primitive is not required -->
        <decision name="DecideOnInferringLocation">
          <case target="GetReceivingLocation" condition="${process.processType}.equalsIgnoreCase('ITEM_RECV')" /> 
          <default target="GetInferredBusinessLocation" />
        </decision>
        
        <activity name="GetReceivingLocation" resource="class:com.oatsystems.solutions.apparel.primitives.GetInferredDefaultLocation">
          <!-- done means that parentLocationEpc is not a site EPC. No inference was done. 
               receivingLocSiteId will not be set. So ensure that it is obtained. 
               rpLocEpc will not be set. However, the incoming message should have it already. -->
          <target name="GetSiteIdForLocation" exit="done" />
          <!-- processed means that parentLocationEpc is a site EPC. Inference was successful. 
          -->
          <target name="GetSiteIdForLocation" exit="processed" />
          <target name="SetVariablesToNullOnError" exit="error" />
          <input name="locationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
          <input name="locSubTypePrefix" class="java.lang.String">'receiving'</input>
          <output name="parentLocationEpc" class="java.lang.String">${process.parentLocationEpc}</output>
          <output name="readPointLocation" class="java.lang.String">${process.rpLocEpc}</output>
          <output name="siteId" class="java.lang.String">${process.receivingLocSiteId}</output>
        </activity>
        

        <!-- Fix for MV-362 - Changed the package name-->    
        <activity name="GetInferredBusinessLocation" resource="class:com.oatsystems.solutions.apparel.primitives.GetInferredLocation">
          <target name="GetAllChildLocations" exit="done" />
          <target name="ERROR" exit="error" />
          <input  name="parentLocationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
          <output name="inferredParentLocationEpc" class="java.lang.String">${process.inferredParentLocationEpc}</output>
        </activity>
        
        <!-- Fix for MV-362 - Changed the package name-->
        <activity name="GetAllChildLocations" resource="class:com.oatsystems.solutions.apparel.primitives.GetAllChildLocations">
          <target name="DecideOnItemRetirement" exit="done" />
          <target name="SetVariablesToNullOnError" exit="error" />
          <input  name="locationEpc" class="java.lang.String">${process.inferredParentLocationEpc}</input>
          <output name="childLocationCount" class="java.lang.String">${process.childLocationCount}</output>
          <output name="childLocationMap" class="java.util.HashMap">${process.childLocationMap}</output>
        </activity>
        <decision name="DecideOnItemRetirement">
          <case target="GetSiteIdForRPLocation" 
              condition="${process.processType}.equalsIgnoreCase('ITEM_POS') or ${process.processType}.equalsIgnoreCase('ITEM_RETIRE') or ${process.processType} .equalsIgnoreCase('ITEM_SHIP')" />
          <default target="GetSiteIdForLocation" />
        </decision>
         <activity name="GetSiteIdForLocation" resource="class:com.oatsystems.solutions.apparel.primitives.GetSiteIdForLocation"> 
           <target name="CheckIfProcessExists" exit="done" /> 
           <target name="SetVariablesToNullOnError" exit="error" /> 
           <input  name="locationEpc" class="java.lang.String">${process.parentLocationEpc}</input> 
           <output name="siteId" class="java.lang.String">${process.receivingLocSiteId}</output> 
           <output name="siteEpc" class="java.lang.String">${process.siteEpc}</output> 
           <output name="siteName" class="java.lang.String">${process.siteName}</output>
		   <output name="locSubtype" class="java.lang.String">${process.locSubtype}</output>
         </activity> 
         <activity name="GetSiteIdForRPLocation" resource="class:com.oatsystems.solutions.apparel.primitives.GetSiteIdForLocation"> 
           <target name="CheckIfProcessExists" exit="done" /> 
           <target name="SetVariablesToNullOnError" exit="error" /> 
           <input  name="locationEpc" class="java.lang.String">${process.readPointEpc}</input> 
           <output name="siteId" class="java.lang.String">${process.receivingLocSiteId}</output> 
           <output name="siteEpc" class="java.lang.String">${process.siteEpc}</output> 
           <output name="siteName" class="java.lang.String">${process.siteName}</output>
		   <output name="locSubtype" class="java.lang.String">${process.locSubtype}</output>
        </activity>
        
         <activity name="CheckIfProcessExists" resource="class:com.oatsystems.solutions.apparel.primitives.CheckProcessExists">
              <target name="StartAssociationProcess" exit="notexists" />
			  <target name="SkipProcessedData" exit="exists" />
              <!-- <target name="InitialiseFailedEpcsList" exit="exists" /> -->
              <target name="SetVariablesToNullOnError" exit="error" />
              <input  name="locationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
              <input name="processType" class="java.lang.String">${process.processType}</input>
              <input name="user" class="java.lang.String">${process.user}</input>
              <input name="processStartTime" class="java.lang.String">${process.processStartTime}</input>
              <input name="processEndTime" class="java.lang.String">${process.processEndTime}</input>
              <input name="processSubType" class="java.lang.String">${process.processSubType}</input>  
              <input name="handheldID" class="java.lang.String">${process.handheldID}</input> 
              <output name="processID" class="java.lang.String">${process.processID}</output>
        </activity>
        
		<activity name="SkipProcessedData" resource="class:com.oatsystems.workflow.primitives.SkipProcessedData">
			<target name="IterateOnTagArrayBatch" exit="done" />
			<target name="SetVariablesToNullOnErrorBatch" exit="error" />
			<input name="processId" class="java.lang.String">${process.processID}</input>
			<input name="processType" class="java.lang.String">${process.processType}</input>
			<input name="processSubType" class="java.lang.String">${process.processSubType}</input>
			<output name="currentIndex" class="java.lang.String">${process.currentIndex}</output>
		</activity>
       
        
        <activity name="StartAssociationProcess" resource="primitive:StartProcess">          
        <target name="InitialiseFailedEpcsList" exit="done" />
          <target name="SetVariablesToNullOnError" exit="error" />
          <input  name="processMasterCode" class="java.lang.String">${process.processType}</input>
          <input name="processData0" class="java.lang.String">${process.processType}</input>
          <input name="processData1" class="java.lang.String">${process.user}</input>
          <input name="processData2" class="java.lang.String">${process.processStartTime}</input>
          <input name="processData3" class="java.lang.String">${process.processEndTime}</input>
          <input name="processData4" class="java.lang.String">${process.elapsedTimeInSeconds}</input>
          <input name="processData5" class="java.lang.String">${process.parentLocationEpc}</input>      
          <input name="processData6" class="java.lang.String">${process.siteEpc}</input>      
          <input name="processData7" class="java.lang.String">${process.handheldID}</input>      
          <input name="processData8" class="java.lang.String">${process.scenarioID}</input>      
          <input name="processData9" class="java.lang.String">${process.processSubType}</input>      
          <output name="processID" class="java.lang.String">${process.processID}</output>
        </activity>
        <activity name="InitialiseFailedEpcsList" resource="primitive:SetVariablesToNull" >
          <target name="IterateOnTagArrayBatch" exit="done" />
          <target name="IterateOnTagArrayBatch" exit="skip" />
          <target name="IterateOnTagArrayBatch" exit="error" />
          <output name="variable0" class="java.util.Set">${process.failedEpcs}</output>
         </activity>
<!--
        <activity name="IterateOnTagArray" resource="primitive:IterateOnObjectArray">
          <target name="DecideIfCurrentLocIdIsNull" exit="continue" />
          <target name="CloseAssociationProcessBatch" exit="break" />
          <input name="iterationRange" class="[Ljava.lang.Object;">${process.tags}</input>
          <input name="currentIndex" class="java.lang.String">${process.currentIndex}</input>
          <output name="currentIndex" class="java.lang.String">${process.currentIndex}</output>
          <output name="currentValue" class="com.oatsystems.workflow.objects.impl.ContaineeImpl">${process.currTag}</output>
        </activity>
        
        -->
    <activity name="IterateOnTagArrayBatch" resource="class:com.oatsystems.workflow.primitives.IterateOnObjectArrayInBatch">
       <target name="DecideIfItemRetirement" exit="continue" />
       <target name="CloseAssociationProcessBatch" exit="break" />
       <target name="SetVariablesToNullOnErrorBatch" exit="error" />
       <input name="iterationRange" class="[Ljava.lang.Object;">${process.tags}</input>
       <input name="currentStartIndex" class="java.lang.String">${process.currentIndex}</input>
       <input name="batchSize" class="java.lang.String">5000</input>
       <output name="currentEndIndex" class="java.lang.String">${process.currentIndex}</output>
       <output name="currentValues" class="[Lcom.oatsystems.workflow.objects.impl.ContaineeImpl;">${process.currBatch}</output>
     </activity>
     
      <decision name="DecideIfItemRetirement">
               <case target="ConvertArrayToArrayList" 
                   condition="${process.processType}.equalsIgnoreCase('ITEM_POS') or ${process.processType}.equalsIgnoreCase('ITEM_RETIRE') or ${process.processType} .equalsIgnoreCase('ITEM_SHIP')" />
               <default target="GetExistingEPCBatch" />
        </decision>
     
     <activity name="ConvertArrayToArrayList" resource="class:com.oatsystems.workflow.primitives.ConvertArrayToArrayList">
             <target name="GetInferredRetirementBusinessLocation" exit="done"/> 
              <target name="CloseAssociationProcessBatch" exit="error"/> 
             <input name="epcListArray" class="[Lcom.oatsystems.workflow.objects.impl.ContaineeImpl;">${process.currBatch}</input>
             <output name="epcList" class="java.util.List">${process.newEpcList}</output>
     </activity>
     
      <activity name="GetInferredRetirementBusinessLocation" resource="class:com.oatsystems.solutions.apparel.primitives.GetInferredLocation">
               <target name="SetParentLocationEPC" exit="done" />
               <target name="CloseAssociationProcessBatch" exit="error" />
               <input  name="parentLocationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
               <input  name="siteEpc" class="java.lang.String">${process.siteEpc}</input>
               <output name="inferredParentLocationEpc" class="java.lang.String">${process.inferredParentLocationEpc}</output>
               <output name="readPointEpc" class="java.lang.String">${process.readPointEpc}</output>
        </activity>
		
		<activity name="SetParentLocationEPC" resource="class:com.oatsystems.workflow.primitives.SetVariableValue">
			<target name="AssociateTagWithNullParentLocation" exit="done"/>
			<target name="CloseAssociationProcessBatch" exit="error"/>
			<input  name="value" class="java.lang.String">${process.inferredParentLocationEpc}</input>
			<output name="variable" class="java.lang.String">${process.parentLocationEpc}</output>
		</activity>
    
     	<activity name="GetExistingEPCBatch" resource="class:com.oatsystems.solutions.apparel.primitives.GetExistingEPCsFromBatch">
        <target name="CheckItemReceiveType" exit="done"/> 
           <target name="SetVariablesToNullOnErrorBatch" exit="error" />
     	  
           <input name="epcListArray" class="[Lcom.oatsystems.workflow.objects.impl.ContaineeImpl;">${process.currBatch}</input>
            <input  name="processType" class="java.lang.String">${process.processType}</input>
           <input name="parentLocationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
            <output name="newEpcList" class="java.util.List">${process.newEpcList}</output>
           <output name="existingEpcList" class="java.util.List">${process.existingEpcList}</output>
    </activity>
	
	<decision name="CheckItemReceiveType">
				<case target="CheckAssociationOrRetirement" 
                   condition="${process.processSubType}.equalsIgnoreCase('TAGGED_HH') and ${process.processType}.equalsIgnoreCase('ITEM_RECV')" />
				<default target="updateExistingEPCs" />
	 </decision>
    
          <activity name="updateExistingEPCs" resource="class:com.oatsystems.workflow.primitives.UpdateExistingEPCs">
              <target name="CheckAssociationOrRetirement" exit="done" />
              <target name="CloseAssociationProcessOnError" exit="error" />
              <input name="epcList" class="java.util.List">${process.existingEpcList}</input>
              <input name="parentLocationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
              <input name="processId" class="java.lang.String">${process.processID}</input>
              <input name="readPointEpc" class="java.lang.String">${process.readPointEpc}</input>
              <input  name="processType" class="java.lang.String">${process.processType}</input>
              <input  name="processSubType" class="java.lang.String">${process.processSubType}</input>          
        </activity>
        
	<activity name="SetRPLocationBatch" resource="class:com.oatsystems.solutions.apparel.primitives.SetRPLocationBatch">
   <target name="CheckAssociationOrRetirement" exit="done"/> 
      <target name="SetVariablesToNullOnErrorBatch" exit="error" />
	  <input name="readPointEpc" class="java.lang.String">${process.readPointEpc}</input>     
      <input name="epcListArray" class="[Lcom.oatsystems.workflow.objects.impl.ContaineeImpl;">${process.currBatch}</input>
      <input name="failedEpcs" class="java.util.Set">${process.failedEpcs}</input>
      <output name="failedEpcs" class="java.util.Set">${process.failedEpcs}</output>
      <output name="epcList" class="java.util.List">${process.newEpcList}</output>
    </activity>
    
    <!--
	<activity name="CheckEpcProductValidityBatch" resource="class:com.oatsystems.workflow.primitives.CheckEpcProductValidityMDBatch">
          <target name="InsertInvalidEpcsToDBatch" exit="done" />
           <target name="InsertInvalidEpcsToDBatch" exit="valid" />
               <target name="CloseAssociationProcessOnErrorBatch" exit="error" />          
		  <input name="epcList" class="java.util.List">${process.newEpcList}</input>		  
		  <output name="epcList" class="java.util.List">${process.newEpcList}</output>
          <output name="invalidepcs" class="java.util.List">${process.invalidepcs}</output>
        </activity>
		
	<activity name="InsertInvalidEpcsToDBatch" resource="class:com.oatsystems.workflow.primitives.InsertInvalidEpcsToDBatch">      

	  <target name="LogInvalidEpcBatch" exit="done"/> 
      <target name="SetVariablesToNullOnErrorBatch" exit="error" />
	  <input name="parentLocationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
      <input  name="processId" class="java.lang.String">${process.processID}</input>
	  <input  name="processType" class="java.lang.String">${process.processType}</input>
      <input  name="processSubType" class="java.lang.String">${process.processSubType}</input>
	  <input name="processStartTime" class="java.lang.String">${process.processStartTime}</input>
      <input name="processEndTime" class="java.lang.String">${process.processEndTime}</input>      
      <input name="invalidepcs" class="java.util.List">${process.invalidepcs}</input>	  
    </activity>
    
	<activity name="LogInvalidEpcBatch" resource="class:com.oatsystems.workflow.primitives.LogProcessErrorBatch">
          <target name="CheckAssociationOrRetirement" exit="done" />
          <target name="CloseAssociationProcessOnErrorBatch" exit="error" />
          <input name="errorCode" class="java.lang.String">ERROR_BAD_ITEM</input>
          <input name="locationEpc" class="java.lang.String">${process.readPointLoc}</input>
          <input name="errorDesc" class="java.lang.String">"An un-received EPC encountered"</input>
          <input name="invalidepcs" class="java.util.List">${process.invalidepcs}</input>
        </activity>
-->

        <decision name="CheckAssociationOrRetirement">

      <!--   <case target="AssociateTagWithNullParentLocation" 
              condition="${process.processType}.equalsIgnoreCase('ITEM_POS') or ${process.processType}.equalsIgnoreCase('ITEM_RETIRE') or ${process.processType} .equalsIgnoreCase('ITEM_SHIP')" /> -->
          <case target="DecideOnReceivingExistingItems"
              condition="${process.processType}.equalsIgnoreCase('ITEM_RECV')" /> 

          <default target="AssociateTagWithParentLocation" />
        </decision>


 
        <decision name="DecideOnReceivingExistingItems">
<!--           
          <case target="CheckEpcReceiveStatus" condition="${process.receiveItemsAgain}.equals('FALSE')" />
          <case target="SetParentLocationForReceiving" condition="${process.receiveItemsAgain}.equals('TRUE')" />
-->
          <default target="SetParentLocationForReceiving" />
        </decision>

  <!--      <activity name="CheckEpcReceiveStatus" resource="class:com.oatsystems.solutions.apparel.primitives.CheckEpcReceiveStatus">
          <target name="SetParentLocationForReceiving" exit="valid"/>
          <target name="IterateOnTagArray" exit="inValid"/>
          <target name="CloseAssociationProcessOnError" exit="error"/>
          <input name="receivingItemEpc" class="java.lang.String">${process.currTag}.getEpc()</input>
          <input name="receivingLocationSiteId" class="java.lang.String">${process.receivingLocSiteId}</input>
        </activity>
-->
        <activity name="SetParentLocationForReceiving" resource="class:com.oatsystems.workflow.primitives.SetVariableValue">
          <target name="AssociateTagWithParentLocation" exit="done"/>
          <target name="AssociateTagWithParentLocation" exit="error"/>
          <input name="value" class="java.lang.String">${process.parentLocationEpc}</input>
          <output name="variable" class="java.lang.String">${process.parentLocationEpcForAssociation}</output>
        </activity>

        <activity name="AssociateTagWithParentLocation" resource="class:com.oatsystems.workflow.primitives.AssociateEpcToLocationMDBatch">
          <target name="LogInvalidEpcAfterAssociationBatch" exit="associated" />
          <target name="CheckTypeOfRFIDProcessOnError" exit="error" />
		<input name="epcList" class="java.util.List">${process.newEpcList}</input>
          <!-- <input name="epcList" class="[Lcom.oatsystems.workflow.objects.impl.ContaineeImpl;">${process.currBatch}</input>
          <input name="epcs" class="[Lcom.oatsystems.workflow.objects.impl.ContaineeImpl;">${process.currBatch}</input>
         <input name="timestamp" class="java.lang.String">${process.currTag}.getReadTimeStamp()</input>-->
          <!--<input name="associationLocationEpc" class="java.lang.String">${process.readPointLoc}</input>-->
          <input name="parentLocationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
          <!--<input  name="logVerification" class="java.lang.String">true</input>-->
          <input  name="processId" class="java.lang.String">${process.processID}</input>
          <!--<input  name="status" class="java.lang.String">${process.currTag}.getDescription()</input>-->
          <input  name="processType" class="java.lang.String">${process.processType}</input>
          <input  name="processSubType" class="java.lang.String">${process.processSubType}</input>
		  <input name="processStartTime" class="java.lang.String">${process.processStartTime}</input>
          <input name="processEndTime" class="java.lang.String">${process.processEndTime}</input>
          <output name="invalidepcs" class="java.util.List">${process.invalidepcs}</output>
          <output name="collectionMap" class="java.util.Map">${process.collectionMap}</output>
          <output name="associatedNewEpcList" class="java.util.List">${process.associatedNewEpcList}</output>
          <output name="epcLastKnownLocationMap" class="java.util.HashMap">${process.epcLastKnownLocationMap}</output>
	</activity>
	
	<activity name="LogInvalidEpcAfterAssociationBatch" resource="class:com.oatsystems.workflow.primitives.LogProcessErrorBatch">
      <!-- Fix for MV-486-->
          <target name="CheckForInvalidRelease" exit="done" />
          <target name="CloseAssociationProcessOnErrorBatch" exit="error" />
          <input name="errorCode" class="java.lang.String">ERROR_BAD_ITEM</input>          
          <input name="errorDesc" class="java.lang.String">"An un-received EPC encountered"</input>
          <input name="invalidepcs" class="java.util.List">${process.invalidepcs}</input>
    </activity>

	<decision name="CheckForInvalidRelease">
                <case target="UpdateReservedItems" condition="(${process.invalidAssociatedEpcList} ne null) and (${process.invalidAssociatedEpcList}.get('invalidRelease') ne null)" />
	        <default target="CheckTypeOfRFIDProcess" />
        </decision>

	<activity name="UpdateReservedItems" resource="class:com.oatsystems.solutions.apparel.primitives.UpdateReservedItems">
	      <target name="ClearReservedItems" exit="done" />
	      <target name="ClearReservedItems" exit="error" />
	      <input name="epcList" class="java.util.List">${process.invalidAssociatedEpcList}.get('invalidRelease')</input>
      </activity>

       <activity name="ClearReservedItems" resource="primitive:SetVariablesToNull">
          <target name="CheckTypeOfRFIDProcess" exit="done" />
          <target name="CheckTypeOfRFIDProcess" exit="skip" />
          <target name="CheckTypeOfRFIDProcess" exit="error" />
	  <output name="variable0" class="java.lang.Object">${process.invalidAssociatedEpcList}</output>
        </activity>


	<decision name="CheckTypeOfRFIDProcess">
		<case target="PopulateReceivingSummary" condition="${process.processType}.equalsIgnoreCase('ITEM_RECV')" />
		<case target="PopulatePutawaySummary" condition="${process.processSubType}.equalsIgnoreCase('PUTAWAY')" />          
    	<default target="IterateOnTagArrayBatch" />
	</decision>

        <decision name="CheckTypeOfRFIDProcessOnError">
                <case target="PopulateReceivingSummaryOnError" condition="${process.processType}.equalsIgnoreCase('ITEM_RECV')" />
                <case target="PopulatePutawaySummaryOnError" condition="${process.processSubType}.equalsIgnoreCase('PUTAWAY')" />
        <default target="CloseAssociationProcessOnErrorBatch" />
        </decision>

	
	<activity name="PopulateReceivingSummary" resource="class:com.oatsystems.solutions.apparel.primitives.PopulateReceivingSummary">
        	<target name="IterateOnTagArrayBatch" exit="done" />
        	<target name="CloseAssociationProcessOnErrorBatch" exit="error" />
		<input name="siteEpc" class="java.lang.String">${process.siteEpc}</input>
		<input name="newEpcList" class="java.util.List">${process.associatedNewEpcList}</input>
    <input name="collectionMap" class="java.util.Map">${process.collectionMap}</input>
<!--        <input name="existingEpcList" class="java.util.List">${process.existingEpcList}</input> -->
		<input name="parentLocationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
		<input  name="processId" class="java.lang.String">${process.processID}</input>
		<input name="processStartTime" class="java.lang.String">${process.processStartTime}</input>
        <input name="processEndTime" class="java.lang.String">${process.processEndTime}</input>
		<input name="user" class="java.lang.String">${process.user}</input>
		<input name="currentStartIndex" class="java.lang.String">${process.currentIndex}</input>
    </activity>

        <activity name="PopulateReceivingSummaryOnError" resource="class:com.oatsystems.solutions.apparel.primitives.PopulateReceivingSummary">
                <target name="CloseAssociationProcessOnErrorBatch" exit="done" />
                <target name="CloseAssociationProcessOnErrorBatch" exit="error" />
                <input name="siteEpc" class="java.lang.String">${process.siteEpc}</input>
                <input name="newEpcList" class="java.util.List">${process.associatedNewEpcList}</input>
    <input name="collectionMap" class="java.util.Map">${process.collectionMap}</input>
<!--        <input name="existingEpcList" class="java.util.List">${process.existingEpcList}</input> -->
                <input name="parentLocationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
                <input  name="processId" class="java.lang.String">${process.processID}</input>
                <input name="processStartTime" class="java.lang.String">${process.processStartTime}</input>
        <input name="processEndTime" class="java.lang.String">${process.processEndTime}</input>
                <input name="user" class="java.lang.String">${process.user}</input>
                <!--input name="currentStartIndex" class="java.lang.String">${process.currentIndex}</input-->
    </activity>


	<activity name="PopulatePutawaySummary" resource="class:com.oatsystems.solutions.apparel.primitives.PopulatePutawaySummary">
        	<target name="IterateOnTagArrayBatch" exit="done" />
        	<target name="CloseAssociationProcessOnErrorBatch" exit="error" />
		<input name="siteEpc" class="java.lang.String">${process.siteEpc}</input>
		<input name="newEpcList" class="java.util.List">${process.associatedNewEpcList}</input>
    <input name="collectionMap" class="java.util.Map">${process.collectionMap}</input>
<!--        <input name="existingEpcList" class="java.util.List">${process.existingEpcList}</input> -->
		<input name="parentLocationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
		<input  name="processId" class="java.lang.String">${process.processID}</input>
		<input name="processStartTime" class="java.lang.String">${process.processStartTime}</input>
          	<input name="processEndTime" class="java.lang.String">${process.processEndTime}</input>
		<input name="user" class="java.lang.String">${process.user}</input>
		<input name="currentStartIndex" class="java.lang.String">${process.currentIndex}</input>
    </activity>

        <activity name="PopulatePutawaySummaryOnError" resource="class:com.oatsystems.solutions.apparel.primitives.PopulatePutawaySummary">
                <target name="CloseAssociationProcessOnErrorBatch" exit="done" />
                <target name="CloseAssociationProcessOnErrorBatch" exit="error" />
                <input name="siteEpc" class="java.lang.String">${process.siteEpc}</input>
                <input name="newEpcList" class="java.util.List">${process.associatedNewEpcList}</input>
    <input name="collectionMap" class="java.util.Map">${process.collectionMap}</input>
<!--        <input name="existingEpcList" class="java.util.List">${process.existingEpcList}</input> -->
                <input name="parentLocationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
                <input  name="processId" class="java.lang.String">${process.processID}</input>
                <input name="processStartTime" class="java.lang.String">${process.processStartTime}</input>
                <input name="processEndTime" class="java.lang.String">${process.processEndTime}</input>
                <input name="user" class="java.lang.String">${process.user}</input>
                <!--input name="currentStartIndex" class="java.lang.String">${process.currentIndex}</input-->
    </activity>


        <activity name="AssociateTagWithNullParentLocation" resource="class:com.oatsystems.workflow.primitives.AssociateEpcToLocationMDBatch">
          <target name="PopulateRetireSummary" exit="associated" />
          <target name="CloseAssociationProcessOnError" exit="error" />
          <input name="epcList" class="java.util.List">${process.newEpcList}</input>
		  <input name="parentLocationEpc" class="java.lang.String">${process.parentLocationEpc}</input>
         <!--<input name="epcList" class="[Lcom.oatsystems.workflow.objects.impl.ContaineeImpl;">${process.currBatch}</input>-->
          <!--<input name="timestamp" class="java.lang.String">${process.currTag}.getReadTimeStamp()</input>
          <input name="associationLocationEpc" class="java.lang.String">${process.currTag}.getCurrentLocationID()</input>
		  <input  name="status" class="java.lang.String">${process.currTag}.getDescription()</input>-->
          <!--<input  name="logVerification" class="java.lang.String">true</input>-->
          <input  name="processId" class="java.lang.String">${process.processID}</input>
          <input  name="processType" class="java.lang.String">${process.processType}</input>
          <input  name="processSubType" class="java.lang.String">${process.processSubType}</input>
		  <input name="processStartTime" class="java.lang.String">${process.processStartTime}</input>
          <input name="processEndTime" class="java.lang.String">${process.processEndTime}</input>    
           <output name="invalidepcs" class="java.util.List">${process.invalidepcs}</output>      
           <output name="sourceLoc" class="java.lang.String">${process.sourceLoc}</output>
	   <output name="invalidAssociatedEpcList" class="java.util.Map">${process.invalidAssociatedEpcList}</output>
	   <output name="associatedNewEpcList" class="java.util.List">${process.associatedNewEpcList}</output>
        <output name="epcLastKnownLocationMap" class="java.util.HashMap">${process.epcLastKnownLocationMap}</output>
        </activity>
        
        <activity name="PopulateRetireSummary" resource="class:com.oatsystems.solutions.apparel.primitives.PopulateRetireSummary">
          <target name="DecideOnLogPOSHistory" exit="done" />
          <target name="CloseAssociationProcessOnError" exit="error" />
          <input name="siteEpc" class="java.lang.String">${process.siteEpc}</input>
          <input name="newEpcList" class="java.util.List">${process.associatedNewEpcList}</input>
          <input  name="status" class="java.lang.String">${process.currTag}.getDescription()</input>
          <input name="readPointEpc" class="java.lang.String">${process.readPointEpc}</input>
          <input  name="processId" class="java.lang.String">${process.processID}</input>
		  <input name="user" class="java.lang.String">${process.user}</input>
          <input  name="processSubType" class="java.lang.String">${process.processSubType}</input>
          <input name="processStartTime" class="java.lang.String">${process.processStartTime}</input>
          <input name="processEndTime" class="java.lang.String">${process.processEndTime}</input>
	  	  <input name="currentStartIndex" class="java.lang.String">${process.currentIndex}</input>
          <input name="sourceLoc" class="java.lang.String">${process.sourceLoc}</input>
          <output name="posEpcs" class="java.util.List">${process.posEpcs}</output>
    	</activity>
    	
    	<decision name="DecideOnLogPOSHistory">
    		<case target="PopulatePOSHistory" condition="${process.processType}.equalsIgnoreCase('ITEM_POS') or ${process.processType}.equalsIgnoreCase('ITEM_RETIRE')"/>
    		<!-- condition="${process.processType}.equalsIgnoreCase('ITEM_POS') or ${process.processType}.equalsIgnoreCase('ITEM_RETIRE') or ${process.processType} .equalsIgnoreCase('ITEM_SHIP')" -->
	        <default target="LogInvalidEpcAfterAssociationBatch" />
    	</decision>
    	
    	<activity name="PopulatePOSHistory" resource="class:com.oatsystems.solutions.apparel.primitives.PopulatePOSHistory">
    			<target  exit="done" name="LogInvalidEpcAfterAssociationBatch"/>
				<target  exit="error" name="LogInvalidEpcAfterAssociationBatch" />
    		<input name="epcList" class="java.util.List">${process.posEpcs}</input>
    		<input name="readerLocationEpc" class="java.lang.String">${process.readPointEpc}</input>
            <input name="epcLastKnownLocationMap" class="java.util.HashMap">${process.epcLastKnownLocationMap}</input>
    	</activity>
    
	<!--activity name="ProcessAsn" resource="class:com.oatsystems.solutions.apparel.primitives.ProcessSubmittedAsn">
		<target name="CloseAssociationProcessRead" exit="done"/>
		<target name="CloseAssociationProcessOnError" exit="error"/>
		<target name="CloseAssociationProcessOnError" exit="continue"/>
		<input name="tags" class="[Lcom.oatsystems.workflow.objects.impl.ContaineeImpl;">${process.tags}</input>		
		<input name="processID" class="java.lang.String">${process.processID}</input>
		<input name="shipmentNumber" class="java.lang.String">${process.shipmentNumber}</input>
		<input name="asnNumber" class="java.lang.String">${process.asnNumber}</input>
		<input name="shipToLoc" class="java.lang.String">${process.shipToLoc}</input>
		<input name="shipFromLoc" class="java.lang.String">${process.shipFromLoc}</input>
		<input name="boxID" class="java.lang.String">${process.boxID}</input>
		<input name="waypointFlag" class="java.lang.String">${process.waypointFlag}</input>
        <input name="toLocDesc" class="java.lang.String">${process.toLocDesc}</input>
		<input name="hhSessionID" class="java.lang.String">${process.hhSessionID}</input>
		<input name="readLocationEpc" class="java.lang.String">${process.readPointEpc}</input>		
        <input name="processSubType" class="java.lang.String">${process.processSubType}</input>
		<input name="processType" class="java.lang.String">${process.processType}</input>
		<input name="locSubtype" class="java.lang.String">${process.locSubtype}</input>
		<input name="transferReason" class="java.lang.String">${process.transferReason}</input>
	</activity-->
        <decision name="CloseAssociationProcess">
	  <!--case target="ProcessAsn" condition="${process.processSubType}.equalsIgnoreCase('ASN_HH') or ${process.processSubType}.equalsIgnoreCase('HH_TRANSFER')" /-->
          <case target="CloseAssociationProcessRetire" condition="${process.processType}.equalsIgnoreCase('ITEM_POS') or ${process.processType}.equalsIgnoreCase('ITEM_RETIRE') or ${process.processType}.equalsIgnoreCase('ITEM_SHIP')" />          
          <default target="CloseAssociationProcessRead" />
        </decision>
        <activity name="CloseAssociationProcessRead" resource="primitive:CloseProcess">
          <target name="SetVariablesToNull" exit="done" />
          <target name="SetVariablesToNull" exit="error" />
          <input name="processID" class="java.lang.String">${process.processID}</input>
          <input name="processData0" class="java.lang.String">${process.processType}</input>
          <input name="processData1" class="java.lang.String">${process.user}</input>
          <input name="processData2" class="java.lang.String">${process.processStartTime}</input>
          <input name="processData3" class="java.lang.String">${process.processEndTime}</input>
          <input name="processData4" class="java.lang.String">${process.elapsedTimeInSeconds}</input>
          <input name="processData5" class="java.lang.String">${process.parentLocationEpc}</input>      
          <input name="processData6" class="java.lang.String">${process.siteEpc}</input>      
          <input name="processData7" class="java.lang.String">${process.handheldID}</input>      
          <input name="processData8" class="java.lang.String">${process.scenarioID}</input>      
          <input name="processData9" class="java.lang.String">${process.processSubType}</input>      
          <output name="processID" class="java.lang.String">${process.processID}</output>
        </activity>
        <activity name="CloseAssociationProcessRetire" resource="primitive:CloseProcess">
          <target name="SetVariablesToNull" exit="done" />
          <target name="SetVariablesToNull" exit="error" />
          <input name="processID" class="java.lang.String">${process.processID}</input>
          <input name="processData0" class="java.lang.String">${process.processType}</input>
          <input name="processData1" class="java.lang.String">${process.user}</input>
          <input name="processData2" class="java.lang.String">${process.processStartTime}</input>
          <input name="processData3" class="java.lang.String">${process.processEndTime}</input>
          <input name="processData4" class="java.lang.String">${process.elapsedTimeInSeconds}</input>
          <input name="processData5" class="java.lang.String">${process.parentLocationEpc}</input>      
          <input name="processData6" class="java.lang.String">${process.siteEpc}</input>      
          <input name="processData7" class="java.lang.String">${process.handheldID}</input>      
          <input name="processData8" class="java.lang.String">${process.scenarioID}</input>      
          <input name="processData9" class="java.lang.String">${process.processSubType}</input>      
          <output name="processID" class="java.lang.String">${process.processID}</output>
        </activity>
        <activity name="SetVariablesToNull" resource="primitive:SetVariablesToNull">
          <target name="DONE" exit="done" />
          <target name="DONE" exit="skip" />
          <target name="ERROR" exit="error" />
          <output name="variable0" class="com.oatsystems.workflow.objects.impl.ContaineeImpl">${process.currTag}</output>
          <output name="variable1" class="java.lang.String">${process.currentIndex}</output>
          <output name="variable3" class="java.lang.Object">${process.parentLocationEpcForAssociation}</output>
          <output name="variable4" class="java.lang.Object">${process.inferredParentLocationEpc}</output>
          
        </activity>
    
        <activity name="CloseAssociationProcessOnError" resource="primitive:CloseProcess">
          <target name="SetVariablesToNullOnError" exit="done" />
          <target name="SetVariablesToNullOnError" exit="error" />
          <input name="processID" class="java.lang.String">${process.processID}</input>
          <input name="processData0" class="java.lang.String">${process.processType}</input>
          <input name="processData1" class="java.lang.String">${process.user}</input>
          <input name="processData2" class="java.lang.String">${process.processStartTime}</input>
          <input name="processData3" class="java.lang.String">${process.processEndTime}</input>
          <input name="processData4" class="java.lang.String">${process.elapsedTimeInSeconds}</input>
          <input name="processData5" class="java.lang.String">${process.parentLocationEpc}</input>
          <input name="processData6" class="java.lang.String">${process.siteEpc}</input>      
          <input name="processData7" class="java.lang.String">${process.handheldID}</input>      
          <input name="processData8" class="java.lang.String">${process.scenarioID}</input>      
          <input name="processData9" class="java.lang.String">${process.processSubType}</input>      
          <output name="processID" class="java.lang.String">${process.processID}</output>
        </activity>

        <activity name="SetVariablesToNullOnError" resource="primitive:SetVariablesToNull">
          <target name="ERROR" exit="done" />
          <target name="ERROR" exit="skip" />
          <target name="ERROR" exit="error" />
          <output name="variable0" class="com.oatsystems.workflow.objects.impl.ContaineeImpl">${process.currTag}</output>
          <output name="variable1" class="java.lang.String">${process.currentIndex}</output>
          <output name="variable3" class="java.lang.Object">${process.parentLocationEpcForAssociation}</output>
          <output name="variable4" class="java.lang.Object">${process.inferredParentLocationEpc}</output>
          
        </activity>
    
        <activity name="SetVariablesToNullOnNonRecoverableError" resource="primitive:SetVariablesToNull">
          <target name="NON_RECOVERABLE_ERROR" exit="done" />
          <target name="NON_RECOVERABLE_ERROR" exit="skip" />
          <target name="NON_RECOVERABLE_ERROR" exit="error" />
          <output name="variable0" class="com.oatsystems.workflow.objects.impl.ContaineeImpl">${process.currTag}</output>
          <output name="variable1" class="java.lang.String">${process.currentIndex}</output>
          <output name="variable3" class="java.lang.Object">${process.parentLocationEpcForAssociation}</output>
          <output name="variable4" class="java.lang.Object">${process.inferredParentLocationEpc}</output>          
        </activity>
        <activity name="CloseAssociationProcessBatch" resource="primitive:CloseProcess">
          <target name="SetBatchVariablesToNull" exit="done" />
          <target name="ERROR" exit="error" />
          <input name="processID" class="java.lang.String">${process.processID}</input>
          <input name="processData0" class="java.lang.String">${process.processType}</input>
          <input name="processData1" class="java.lang.String">${process.user}</input>
          <input name="processData2" class="java.lang.String">${process.processStartTime}</input>
          <input name="processData3" class="java.lang.String">${process.processEndTime}</input>
          <input name="processData4" class="java.lang.String">${process.elapsedTimeInSeconds}</input>
          <input name="processData5" class="java.lang.String">${process.parentLocationEpc}</input>      
          <input name="processData6" class="java.lang.String">${process.siteEpc}</input>      
          <input name="processData7" class="java.lang.String">${process.handheldID}</input>      
          <input name="processData8" class="java.lang.String">${process.scenarioID}</input>      
          <input name="processData9" class="java.lang.String">${process.processSubType}</input>      
          <output name="processID" class="java.lang.String">${process.processID}</output>
        </activity>
         <activity name="SetBatchVariablesToNull" resource="primitive:SetVariablesToNull">
          <target name="DONE" exit="done" />
          <target name="DONE" exit="skip" />
          <target name="ERROR" exit="error" />
          <output name="variable0" class="[Lcom.oatsystems.workflow.objects.impl.ContaineeImpl;">${process.currBatch}</output>
          <output name="variable1" class="java.lang.String">${process.currentIndex}</output>
          <output name="variable3" class="java.lang.Object">${process.parentLocationEpcForAssociation}</output>
          <output name="variable4" class="java.lang.Object">${process.inferredParentLocationEpc}</output>          
        </activity>
		<activity name="CloseAssociationProcessOnErrorBatch" resource="primitive:CloseProcess">
          <target name="SetVariablesToNullOnErrorBatch" exit="done" />
          <target name="SetVariablesToNullOnErrorBatch" exit="error" />
          <input name="processID" class="java.lang.String">${process.processID}</input>
          <input name="processData0" class="java.lang.String">${process.processType}</input>
          <input name="processData1" class="java.lang.String">${process.user}</input>
          <input name="processData2" class="java.lang.String">${process.processStartTime}</input>
          <input name="processData3" class="java.lang.String">${process.processEndTime}</input>
          <input name="processData4" class="java.lang.String">${process.elapsedTimeInSeconds}</input>
          <input name="processData5" class="java.lang.String">${process.parentLocationEpc}</input>
          <input name="processData6" class="java.lang.String">${process.siteEpc}</input>      
          <input name="processData7" class="java.lang.String">${process.handheldID}</input>      
          <input name="processData8" class="java.lang.String">${process.scenarioID}</input>      
          <input name="processData9" class="java.lang.String">${process.processSubType}</input>      
          <output name="processID" class="java.lang.String">${process.processID}</output>
        </activity>
		<activity name="SetVariablesToNullOnErrorBatch" resource="primitive:SetVariablesToNull">
          <target name="ERROR" exit="done" />
          <target name="ERROR" exit="skip" />
          <target name="ERROR" exit="error" />
          <output name="variable0" class="[Lcom.oatsystems.workflow.objects.impl.ContaineeImpl;">${process.currBatch}</output>
          <output name="variable1" class="java.lang.String">${process.currentIndex}</output>
          <output name="variable3" class="java.lang.Object">${process.parentLocationEpcForAssociation}</output>
          <output name="variable4" class="java.lang.Object">${process.inferredParentLocationEpc}</output>
		 <output name="variable5" class="java.lang.Object">${process.newEpcList}</output>
		 <output name="variable6" class="java.lang.Object">${process.invalidepcs}</output>
          
        </activity>
    
    
    
        <end name="ERROR"></end>
        <end name="DONE"></end>
		<end name="NON_RECOVERABLE_ERROR"></end>
        
    </process>

    <config/>

    <display/>
</scenario>
